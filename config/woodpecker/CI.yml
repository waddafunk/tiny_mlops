when:
  - event: [push, pull_request]

clone:
  git:
    image: woodpeckerci/plugin-git

steps:
  - name: setup
    image: debian:bullseye-slim
    commands:
      - apt-get update
      - apt-get install -y curl shellcheck shfmt yamllint
      
  - name: format-shell
    image: debian:bullseye-slim
    commands:
      - shfmt -l -w -i 4 *.sh
      - shellcheck *.sh
    
  - name: format-yaml
    image: debian:bullseye-slim
    commands:
      - yamllint -c .yamllint.yml .
      - |
        for file in $(find . -name "*.yml" -o -name "*.yaml"); do
          yamllint -f parsable $file
        done

  - name: check-nginx
    image: nginx:alpine
    commands:
      - nginx -t -c /etc/nginx/nginx.conf
      
  - name: verify-no-credentials
    image: debian:bullseye-slim
    commands:
      - |
        # Check for hardcoded credentials
        ! grep -r -i "password\|secret\|key" --exclude-dir=.git --exclude="*.enc" .
      - |
        # Check for private keys
        ! find . -type f -name "*.pem" -o -name "*.key"

  - name: validate-docker-compose
    image: docker/compose:latest
    commands:
      - docker-compose -f services/docker-compose.yml config

  - name: push_changes
    image: alpine/git:latest
    commands:
      - git config --global user.name "${CI_COMMIT_AUTHOR}"
      - git config --global user.email "${CI_COMMIT_AUTHOR_EMAIL}"
      - git remote set-url origin "https://oauth2:$${git_push_token}@github.com/${CI_REPO}.git"
      - git add --all
      - |
        if [ -n "$(git status --porcelain)" ]; then
          git commit -m "[CI skip] Autocommit, upgrade & format"
          echo "Pushing changes..."
          git push origin ${CI_COMMIT_BRANCH}
        else
          echo "No changes to commit"
        fi
    secrets: [ git_push_token ]
    when:
      status: [ success ]